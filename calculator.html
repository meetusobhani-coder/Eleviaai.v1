<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elevia ‚Äî Calculator</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header class="site-header">
  <h1 class="site-title">Elevia</h1>
  <button id="signOutBtn" class="signout-btn" style="display:none;">Sign Out</button>
</header>

<!-- Sign In / Sign Up Popup -->
<div id="auth-popup" class="popup-overlay">
  <div class="popup-box">
    <h2>Welcome to Elevia ‚ú®</h2>
    <input type="text" id="name" placeholder="Full Name" class="popup-input" />
    <input type="email" id="email" placeholder="Email" class="popup-input" />
<label style="font-size:13px; text-align:left; display:block; margin:10px;">
  <input type="checkbox" id="acceptTnc" />
  I agree to the 
  <a href="Elevia - T&C.pdf" target="_blank">Terms & Conditions</a>
</label>

    <button onclick="signInUser()" class="popup-btn">Continue</button>
  </div>
</div>

<main class="main-center">
  <section class="calculator-wrap">
    <h2 class="calc-intro">Discover your readiness to manifest your desires. Adjust your intention, focus, and energy levels to see your manifestation readiness score!</h2>

   <form id="manifestationForm" class="calc-form" onsubmit="return false;">
    <label>‚ú® Intention
        <select id="intention">
          <option value="">‚Äî Select intention ‚Äî</option>
          <option value="Love">Love</option>
          <option value="Career">Career</option>
          <option value="Family">Family</option>
          <option value="Health">Health</option>
          <option value="Wealth">Wealth</option>
          <option value="Self">Self-Growth</option>
        </select>
        <small>Choose your main focus for manifestation.</small>
      </label>

      <label>‚è≥ Timing Readiness (1‚Äì10)
        <select id="timing">
          <option value="">‚Äî Select 1‚Äì10 ‚Äî</option>
          <option value="1">1 (Low)</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10 (High)</option>
        </select>
        <small>Is now the right time for this wish?</small>
      </label>

      <label>üèÉ Action Alignment (1‚Äì10)
        <select id="action">
          <option value="">‚Äî Select 1‚Äì10 ‚Äî</option>
          <option value="1">1 (Low)</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10 (High)</option>
        </select>
        <small>Are your actions aligned with your wish?</small>
      </label>

      <label>üéØ Milestone Clarity (1‚Äì10)
        <select id="clarity">
          <option value="">‚Äî Select 1‚Äì10 ‚Äî</option>
          <option value="1">1 (Low)</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10 (High)</option>
        </select>
        <small>How clear is your goal?</small>
      </label>

      <label>üåà Patience Level
        <select id="patience">
          <option value="">‚Äî Select ‚Äî</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
        </select>
        <small>How calm can you stay if things don‚Äôt go perfectly?</small>
      </label>

      <label>‚ù§Ô∏è Emotional Energy (¬∞)
        <select id="phi">
          <option value="">‚Äî Select ‚Äî</option>
          <option value="0">0¬∞ (Low	)</option>
          <option value="180">180¬∞ (Moderate)</option>
          <option value="360">360¬∞ (High)</option>
        </select>
        <small>How emotionally charged are you for this wish?</small>
      </label>

      <div class="buttons-row">
        <button type="button" id="calculateBtn">Calculate</button>
        <button type="button" id="resetBtn">Reset</button>
      </div>

      <div class="buttons-row">
        <a href="index.html" class="btn">Back to Home</a>
        <a href="details.html" class="btn">Go to Consulting</a>
      </div>
    </form>

    <div id="result" class="result-panel" style="display:none;"></div>

    <div id="adminPanel" style="display:none; margin-top:20px;">
      <button id="downloadDataBtn" class="btn">Download All Data (CSV)</button>
    </div>
  </section>
</main>

<footer class="site-footer"><p>¬© 2025 Elevia</p></footer>

<script>
const SUPABASE_URL = "https://dvvktlngsiqerhsikfna.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2dmt0bG5nc2lxZXJoc2lrZm5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTI5ODksImV4cCI6MjA3ODQyODk4OX0.IGIeZLmEWwUsof-Fj_vIAHhhlvIFN-yjVjHsJHluBcM";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// -------- AUTH --------
function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
}

async function signInUser() {
  console.log("signInUser triggered");

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const accepted = document.getElementById("acceptTnc").checked;

  // 1Ô∏è‚É£ Basic validation
  if (!name || !email) {
    alert("Please enter name and email.");
    return;
  }

  // 2Ô∏è‚É£ Email format validation
  if (!isValidEmail(email)) {
    alert("Please enter a valid email address (example: name@email.com).");
    return;
  }

  // 3Ô∏è‚É£ T&C validation
  if (!accepted) {
    alert("Please accept the Terms & Conditions to continue.");
    return;
  }

  // 4Ô∏è‚É£ Save locally FIRST (so UI never blocks)
  localStorage.setItem("userName", name);
  localStorage.setItem("userEmail", email);

  // 5Ô∏è‚É£ Single Supabase upsert (WITH T&C)
  const { error } = await client
    .from("Users")
    .upsert(
      [{
        name,
        email,
        accepted_tnc: true,
        accepted_tnc_at: new Date().toISOString()
      }],
      { onConflict: "email" }
    );


  // 6Ô∏è‚É£ Handle Supabase error safely (do NOT block user)
  if (error) {
    console.warn(
      "Supabase insert skipped (likely RLS / anon key):",
      error.message
    );
    // DO NOT return ‚Äî login must still succeed
  }

  // 7Ô∏è‚É£ UI success
  document.getElementById("auth-popup").style.display = "none";
  document.getElementById("signOutBtn").style.display = "inline-block";

  if (email === "admin@elevia.com") {
    document.getElementById("adminPanel").style.display = "block";
  }
}

// ---------- SESSION RESTORE ----------
window.onload = () => {
  const email = localStorage.getItem("userEmail");

  if (email && isValidEmail(email)) {
    document.getElementById("auth-popup").style.display = "none";
    document.getElementById("signOutBtn").style.display = "inline-block";

    if (email === "admin@elevia.com") {
      document.getElementById("adminPanel").style.display = "block";
    }
  } else {
    document.getElementById("auth-popup").style.display = "flex";
  }
};


  

document.getElementById("signOutBtn").onclick = () => {
  localStorage.clear();
  location.reload();
};

// -------- CALCULATE --------
document.getElementById("calculateBtn").onclick = async () => {
const accepted_tnc = true;
const accepted_tnc_at = new Date().toISOString();
const created_at = new Date().toISOString();

   const name = localStorage.getItem("userName") || "there";
  const email = localStorage.getItem("userEmail");

  const intention = document.getElementById("intention").value;
  const timing = parseInt(document.getElementById("timing").value);
  const action = parseInt(document.getElementById("action").value);
  const clarity = parseInt(document.getElementById("clarity").value);
  const patience = document.getElementById("patience").value;
  const phi = parseInt(document.getElementById("phi").value);

  if (
  !intention ||
  isNaN(timing) ||
  isNaN(action) ||
  isNaN(clarity) ||
  !patience ||
  isNaN(phi)
) {
  alert("Please fill out all fields.");
  return;
}


let patienceVal = patience === "High" ? 10 : patience === "Medium" ? 6 : 3;
let score = Math.round((timing + action + clarity + patienceVal + phi / 36) / 5);

// ---------------- PERSONA ----------------
let persona = "";
if (score >= 8) {
  persona = "The Aligned Accelerator";
} else if (score >= 5) {
  persona = "The Steady Realigner";
} else {
  persona = "The Inner Rebuilder";
}

// ---------------- WEAKEST AREA ----------------
let weakest = "clarity";
if (timing <= action && timing <= clarity) weakest = "timing";
else if (action <= timing && action <= clarity) weakest = "action";

let weaknessMessage = "";
if (weakest === "timing") {
  weaknessMessage =
    "Right now, it‚Äôs not a lack of desire ‚Äî it‚Äôs about allowing the timing to mature rather than forcing momentum.";
} else if (weakest === "action") {
  weaknessMessage =
    "Your intention is present, but consistent aligned action is where the real shift can happen.";
} else {
  weaknessMessage =
    "Your energy is active, but refining clarity will help the universe respond more precisely.";
}

// ---------------- EMOTION + PATIENCE ----------------
let emotionMessage = "";
if (phi === 360 && patience === "Low") {
  emotionMessage =
    "Your emotional energy is intense, but impatience may be creating internal friction.";
} else if (phi === 360 && patience === "High") {
  emotionMessage =
    "You‚Äôre emotionally invested while remaining grounded ‚Äî this is a powerful combination.";
} else if (phi === 180) {
  emotionMessage =
    "Your emotional energy is balanced, suggesting steady progress rather than dramatic shifts.";
} else {
  emotionMessage =
    "Low emotional charge suggests this intention may need deeper personal meaning to activate momentum.";
}

// ---------------- FINAL MESSAGE ----------------
let message = `


  <p><strong>Dear ${name},</strong></p>

  <p>
    Your current manifestation score for <strong>${intention}</strong> is
    <strong>${score}/10</strong>.
  </p>

  <div style="
    display:inline-block;
    margin:18px 0 24px;
    padding:14px 28px;
    background:#eef2ff;
    color:#4338ca;
    font-weight:700;
    font-size:1.20rem;
    border-radius:999px;
   display: inline-block;
letter-spacing:0.3px;
  box-shadow:0 6px 16px rgba(79,70,229,0.18);


  ">
    Persona: ${persona}
  </div>

  <p>${weaknessMessage}</p>

  <p>${emotionMessage}</p>

  <p>
    This phase isn‚Äôt about doing more ‚Äî it‚Äôs about aligning more intentionally.
  </p>

  <div style="
    margin-top:16px;
    padding:12px;
    background:#f0f4ff;
    border-left:4px solid #4f46e5;
    border-radius:6px;
  ">
    Want deeper clarity tailored specifically to you?
    <strong>
      <a href="details.html" style="color:#4f46e5;text-decoration:underline;">
        Go to Consulting
      </a>
    </strong>
  </div>
`;

document.getElementById("result").style.display = "block";
document.getElementById("result").innerHTML = message;

// ---------------- STORE IN SUPABASE ----------------
  
  await client.from("Calculations").insert([{
    user_email: email,
    intention,
    timing,
    action,
    clarity,
    patience,
    phi,
    score,
    result_message: message.replace(/<[^>]+>/g, ""),
    accepted_tnc,
  accepted_tnc_at,
 created_at
}]);
};

// -------- RESET --------
document.getElementById("resetBtn").onclick = () => {
  document.getElementById("manifestationForm").reset();
  document.getElementById("result").style.display = "none";
};

// -------- ADMIN DOWNLOAD --------
document.getElementById("downloadDataBtn").onclick = async () => {
  const { data, error } = await client.from("Calculations").select("*");
  if (error) return alert("Error fetching data.");

  let csv = "User Email,Intention,Timing,Action,Clarity,Patience,Phi,Score,Message,Date\n";
  data.forEach(row => {
    csv += `${row.user_email},${row.intention},${row.timing},${row.action},${row.clarity},${row.patience},${row.phi},${row.score},"${row.result_message}",${row.created_at}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Elevia_Calculations.csv";
  a.click();
};
</script>

<style>
body {font-family: Poppins, sans-serif; background:#f3f5f9; color:#1f2937; text-align:center;}
.site-header{display:flex;justify-content:center;align-items:center;position:relative;padding:1rem;}
.signout-btn{position:absolute;right:10px;background:#ff7675;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;}
.popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;}
.popup-box{background:#fff;padding:20px;border-radius:12px;width:300px;}
.popup-input{width:90%;margin:8px;padding:8px;border:1px solid #ddd;border-radius:8px;}
.popup-btn{background:#6366f1;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}
.calc-form label{display:block;margin:10px 0;}
select{padding:5px;border-radius:6px;}
.buttons-row{margin:10px 0;}
.btn,button{background:#6366f1;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;margin:4px;}
.result-panel{background:#fff;border-radius:12px;padding:15px;margin-top:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
</style>
</body>
</html>